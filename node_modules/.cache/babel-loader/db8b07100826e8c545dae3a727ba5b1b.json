{"ast":null,"code":"/**\n * @author Kuitos\n * @homepage https://github.com/kuitos/\n * @since 2017-10-12\n */\nimport * as tslib_1 from \"tslib\";\nimport LRUCache from 'lru-cache';\nimport buildSortedURL from './utils/buildSortedURL';\nimport isCacheLike from './utils/isCacheLike';\nvar FIVE_MINUTES = 1000 * 60 * 5;\nvar CAPACITY = 100;\nexport default function cacheAdapterEnhancer(adapter, options) {\n  var _this = this;\n\n  if (options === void 0) {\n    options = {};\n  }\n\n  var _a = options.enabledByDefault,\n      enabledByDefault = _a === void 0 ? true : _a,\n      _b = options.cacheFlag,\n      cacheFlag = _b === void 0 ? 'cache' : _b,\n      _c = options.defaultCache,\n      defaultCache = _c === void 0 ? new LRUCache({\n    maxAge: FIVE_MINUTES,\n    max: CAPACITY\n  }) : _c;\n  return function (config) {\n    var url = config.url,\n        method = config.method,\n        params = config.params,\n        paramsSerializer = config.paramsSerializer,\n        forceUpdate = config.forceUpdate;\n    var useCache = config[cacheFlag] !== void 0 && config[cacheFlag] !== null ? config[cacheFlag] : enabledByDefault;\n\n    if (method === 'get' && useCache) {\n      // if had provide a specified cache, then use it instead\n      var cache_1 = isCacheLike(useCache) ? useCache : defaultCache; // build the index according to the url and params\n\n      var index_1 = buildSortedURL(url, params, paramsSerializer);\n      var responsePromise = cache_1.get(index_1);\n\n      if (!responsePromise || forceUpdate) {\n        responsePromise = function () {\n          return tslib_1.__awaiter(_this, void 0, void 0, function () {\n            var reason_1;\n            return tslib_1.__generator(this, function (_a) {\n              switch (_a.label) {\n                case 0:\n                  _a.trys.push([0, 2,, 3]);\n\n                  return [4\n                  /*yield*/\n                  , adapter(config)];\n\n                case 1:\n                  return [2\n                  /*return*/\n                  , _a.sent()];\n\n                case 2:\n                  reason_1 = _a.sent();\n                  cache_1.del(index_1);\n                  throw reason_1;\n\n                case 3:\n                  return [2\n                  /*return*/\n                  ];\n              }\n            });\n          });\n        }(); // put the promise for the non-transformed response into cache as a placeholder\n\n\n        cache_1.set(index_1, responsePromise);\n        return responsePromise;\n      }\n      /* istanbul ignore next */\n\n\n      if (process.env.LOGGER_LEVEL === 'info') {\n        // eslint-disable-next-line no-console\n        console.info(\"request cached by cache adapter: \" + index_1);\n      }\n\n      return responsePromise;\n    }\n\n    return adapter(config);\n  };\n}","map":null,"metadata":{},"sourceType":"module"}